---
title: "Validity of ambbesoeg"
output: html_document
---
Ambbesoeg is a derived variable. I want to ensure that no contacts from besoeg_fysiske_fremmoeder with ambbesoeg = 1 occur in telefon_video_konsultationer_psyk_somatik.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DBI)
library(data.table)
library(dtplyr)
library(dplyr, warn.conflicts = FALSE)
library(lubridate)
library(ggplot2)
library(stringr)
library(tidyr)
library(tidyverse)
library(qwraps2)
library(xlsx)

```



```{r}
conn <- DBI::dbConnect(
  odbc::odbc(),
  Driver = "SQL Server",
  Server = "BI-DPA-PROD",
  database = "USR_PS_Forsk",
  Trusted_Connection = "TRUE"
)

df_fys_raw <- dbGetQuery(conn, "SELECT * FROM [fct].FOR_besoeg_fysiske_fremmoeder") %>% 
  rename_with(tolower)

df_tlf_raw <- dbGetQuery(conn, "SELECT * FROM [fct].FOR_telefon_video_konsultationer_psyk_somatik_LPR2") %>% 
  rename_with(tolower)

df_tlf <- df_tlf_raw %>%
  select(dw_ek_borger, datotid_udfoert) %>%
  rename(datotid_start = datotid_udfoert) %>% 
  mutate(tlf = 1)
```

Isolate ambbesoeg from df_fys_raw

```{r}
df_fys_isolated <- df_fys_raw %>% 
  filter(ambbesoeg == 1) %>% 
  select(dw_ek_borger, datotid_start) %>% 
  mutate(fys = 1)
```

Check no overlap with tlf. We find all visits that are on the same day with the same patient. This ensures we don't miss any overlaps.

```{r}
df_overlap <- bind_rows(df_fys_isolated, df_tlf) %>% 
  mutate(dato_start = as.Date(ymd_hms(datotid_start)))
  
df_arranged <- df_overlap %>% 
  group_by(dw_ek_borger, datotid_start) %>% 
  mutate(contact_nr_on_date = row_number(),
         contacts_on_date = n()) %>% 
  filter(contacts_on_date > 1)#  %>% 
  # arrange(dw_ek_borger, datotid_start)
  
```

No records are in both dataframes while being unique on dw_ek_borger and datotid_start. This is good! Looks like none have to be removed from fysiske_fremmoeder.
