---
title: "debug_construct_sequences"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Do we lose visits when using thresholds?
```{r}
source(here("src", "functions.r"))

df_outpatient_preprocessed <- read_csv(here("csv", "df_outpatient_preprocessed.csv"))

df_outpatient_constructed_3m_threshold <- df_outpatient_preprocessed %>%
  construct_sequences(
    clinic_id_col = shakafskode_besoeg,
    patient_id_col = dw_ek_borger,
    date_col = datotid_start,
    threshold_months = 3,
    verbose = TRUE
  )

write_csv(df_outpatient_constructed_3m_threshold, here("csv", "df_outpatient_constructed_3m_threshold.csv"))
```

```{r}
source(here("src", "functions.r"))
```

```{r}
df_outpatient_constructed_3m_threshold <- read_csv(here("csv", "df_outpatient_constructed_3m_threshold.csv"))

df_outpatient_constructed_3m_threshold_default <- df_outpatient_constructed_3m_threshold %>%
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE, truncation_levels = FALSE)

write_csv(df_outpatient_constructed_3m_threshold_default, here("csv", "df_outpatient_constructed_3m_threshold_default.csv"))
```


```{r}
df_threshold_summarised <- read_csv(here("csv", "df_outpatient_constructed_3m_threshold_default.csv"))
df_naive_summarised <- read_csv(here("csv", "df_outpatient_constructed_no_threshold_default.csv"))

df_source_threshold <- read_csv(here("csv", "df_outpatient_constructed_3m_threshold.csv"))
df_source_naive <- read_csv(here("csv", "df_outpatient_constructed_no_threshold.csv"))
```


Are there an identical number of patients in periods?
```{r}
identical(
  df_threshold_summarised$n,
  df_naive_summarised$n
)
```

Is the NA rate the same?
```{r}
pacman::p_load(skimr)

skim(df_source_threshold)
skim(df_source_naive)
```

Are the source-DF dimensions the same?
```{r}
dim(df_source_threshold)
dim(df_source_naive)
```

What does "NA introduced by coercion" mean when running `recode_with_most_severe_diagnosis_for_sequence`?

```{r}
source(here("src", "functions.r"))

## undebug(recode_with_most_severe_diagnosis_for_sequence)

df_threshold_most_severe <- df_source_threshold %>%
  slice_sample(prop = 0.01) %>%
  mutate(adiagnosekode_2 = substr(adiagnosekode, 2, 2)) %>%
  recode_with_most_severe_diagnosis_for_sequence(constructed_id)

df_threshold_most_severe %>%
  filter(adiagnosekode_2 == "e")
```

For some reason, about 10% of the rows don't have psychiatric diagnosis codes. This should be fixed now, since I added "keep_only_psych_visits" to preprocessing