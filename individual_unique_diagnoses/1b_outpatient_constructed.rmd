---
title: "individual_unique_diagnoses_by_date"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r}
source("0_setup_env_unique_diagnoses.r")
```

## Data wrangling 
Base dataframes
```{r}
df_outpatient_preprocessed <- df_raw_outpatient %>%
  select(dw_ek_borger,
         datotid_start, 
         adiagnosekode, 
         ambbesoeg, 
         dw_sk_lpr3forloebsansvar,
         dw_sk_kontakt,
         shakgeografiafskode_besoeg) %>% 
  rename(clinic = shakgeografiafskode_besoeg) %>% 
  add_LPR23_quarter_column() %>% 
  filter(period > ymd("2012-05-01")) %>% 
  mutate(constructed_id = paste0(dw_ek_borger, clinic)) # Remove weird periods
```

```{r}
source("../src/functions.r")

df_outpatient_preprocessed <- df_raw_outpatient %>%
  mutate(no_threshold_constructed_id = paste0(dw_ek_borger, shakgeografiafskode_besoeg)) %>% 
  select(dw_ek_borger,
         datotid_start, 
         adiagnosekode, 
         ambbesoeg, 
         dw_sk_lpr3forloebsansvar,
         dw_sk_kontakt,
         shakgeografiafskode_besoeg,
         no_threshold_constructed_id) %>% 
  slice_sample(prop = 1) %>% 
  construct_sequences(clinic_id_col=shakgeografiafskode_besoeg, 
                      patient_id_col=dw_ek_borger, 
                      date_col=datotid_start, 
                      threshold_months=3, 
                      verbose = TRUE)
  
```

```{r}
df_outpatient_constructed_default <- df_outpatient_with_constructed_sequences %>%
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE)

df_outpatient_constructed_most_severe <- df_outpatient_with_constructed_sequences %>%
  recode_with_most_severe_diagnosis_for_sequence(constructed_id) %>% 
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE)
```

```{r}
df_outpatient_constructed_last_visit_only <- df_outpatient_with_constructed_sequences %>%
  recode_diagnoses_with_last_in_sequence(constructed_id) %>% 
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE)

log_time()

```

## Plotting
```{r fig.height=5, fig.width=10}
log_time()
source("../src/individual_unique_diagnoses_functions.r")

df_mitigation_constructed_plot <- df_outpatient_constructed_default %>% 
        filter(period > ymd("2012-12-31")) %>% 
        mutate(origin = "outpatient_all") %>% 
        bind_rows(mutate(df_outpatient_constructed_most_severe, origin = "most_severe")) %>% 
        bind_rows(mutate(df_outpatient_constructed_last_visit_only, origin = "final_visit")) %>% 
        mutate(period = as.Date(period)) %>% 
        filter(period > ymd("2019-01-01") | origin == "outpatient_all") %>% 
        mutate(origin = case_when(origin == "outpatient_all" ~ "Unmitigated",
                                origin == "final_visit" ~ "Final visit",
                                origin == "most_severe" ~ "Most severe"))

mitigation_constructed_plot <- save_mitigation_strategy_plot(df_mitigation_constructed_plot, "mitigation_constructed")

mitigation_constructed_plot
```

# Testing
Mitigation
```{r}
df_mitigation <- df_outpatient_constructed_default %>% 
                            filter(period > ymd("2012-12-31")) %>% 
                            mutate(origin = "outpatient_all") %>% 
                            bind_rows(mutate(df_outpatient_constructed_most_severe, origin = "most_severe")) %>% 
                            bind_rows(mutate(df_outpatient_constructed_last_visit_only, origin = "final_visit")) %>% 
                            mutate(period = as.Date(period))


pacman::p_load(fable, tsibble, feasts, urca)

# Binary indicator for date in LPR2/LPR3
df_mitigation <- df_mitigation %>% 
  mutate(lpr3 = if_else(period < "2019-02-03", 0, 1)) 
  

# What to report? 
# pdq(0,0,0) = linear model / t.test (no detrending)
# pdq(0,1,0) = liear model with differencing
# pdq(1,1,0) = autoregressive model with differencing
df_mitigation %>% 
  mutate(period = yearquarter(period)) %>%
  select(starts_with("mean"), period, origin, lpr3) %>% 
  pivot_longer(cols=starts_with("mean"), names_to = "mean_n") %>% 
  as_tsibble(key = c(origin, mean_n), index = period) %>% 
  model(arima = ARIMA(value ~ 1 + lpr3 + pdq(0,0,0) + PDQ(0,0,0))) %>% 
  coef() %>% 
  select(!.model)
```

Truncation
Changepoints plotted on original time series
```{r}

source("src/change_point_detection.R")

changepoint_plots <- list()
for(truncation_level in unique(df_truncation$truncation)){
  sub <- df_truncation %>% 
    filter(truncation == truncation_level) %>% 
    arrange(period)
  p <- estimate_and_plot_changepoints(
    sub$mean,
    sub$period,
    do_smoothing = FALSE,
    detrend_method = "difference") +
    labs(title = truncation_level)
  
  changepoint_plots[[truncation_level]] <- p
}
wrap_plots(changepoint_plots)

```


Plot original and detrended time series
```{r}
detrended_ts <- list()
for(truncation_level in unique(df_truncation$truncation)){
  sub <- df_truncation %>% 
    filter(truncation == truncation_level) %>% 
    arrange(period)
  p <- plot_detrended_ts(sub$mean,
                                 sub$period,
                               detrending_method = "difference",
                         do_smoothing = FALSE) +
    labs(title = truncation_level)
  
  detrended_ts[[truncation_level]] <- p
}

wrap_plots(detrended_ts)

```


Hypothesis test: was there a change diagnoses during the transition?
```{r}

# binary indicator for date in LPR2/LPR3
df_truncation <- df_truncation %>% 
  mutate(lpr3 = if_else(period < "2019-02-03", 0, 1)) 
  

# What to report? 
# pdq(0,0,0) = linear model / t.test (no detrending)
# pdq(0,1,0) = liear model with differencing
# pdq(1,1,0) = autoregressive model with differencing
df_truncation %>% 
  mutate(period = yearquarter(period)) %>% 
  as_tsibble(key = truncation, index = period) %>% 
  model(arima = ARIMA(mean ~ 1 + lpr3 + pdq(1,1,0) + PDQ(0,0,0))) %>% 
  coef() %>% 
  select(!.model)


```