---
title: "individual_unique_diagnoses_by_date"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r}
source("0_setup_env_unique_diagnoses.r")
```

## Data wrangling 
Base dataframes
```{r}
df_outpatient_for_individual <- df_raw_outpatient %>%
  select(dw_ek_borger, 
         datotid_start, 
         adiagnosekode, 
         ambbesoeg) %>% 
  filter(ambbesoeg == 1) %>% 
  add_LPR23_quarter_column() %>% 
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE) %>% 
  filter(period > ymd("2012-05-01")) # Remove weird periods

df_outpatient_most_severe <- df_raw_outpatient %>%
  select(dw_ek_borger, 
         datotid_start, 
         adiagnosekode, 
         ambbesoeg, 
         dw_sk_lpr3forloebsansvar, 
         dw_sk_kontakt) %>% 
  filter(ambbesoeg == 1) %>% 
  add_LPR23_quarter_column() %>% 
  recode_with_most_severe_diagnosis_for_sequence(dw_sk_kontakt, dw_sk_lpr3forloebsansvar, two_columns = TRUE) %>% 
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE) %>% 
  filter(period > ymd("2012-05-01")) # Remove weird periods

df_outpatient_last_visit_only <- df_raw_outpatient %>%
  select(dw_ek_borger,
         datotid_start, 
         adiagnosekode, 
         ambbesoeg, 
         dw_sk_lpr3forloebsansvar,
         dw_sk_kontakt) %>% 
  filter(ambbesoeg == 1) %>% 
  recode_diagnoses_with_last_in_sequence(dw_sk_kontakt, dw_sk_lpr3forloebsansvar, two_columns = TRUE) %>% 
  add_LPR23_quarter_column() %>%
  gen_unique_diagnoses_pr_patient(confidence_intervals = TRUE) %>% 
  filter(period > ymd("2012-05-01")) # Remove weird periods

log_time()

```

Truncation
```{r}
df_truncation <- df_outpatient_for_individual %>% 
    filter(period > ymd("2012-12-31")) %>% 
    pivot_longer(cols=c(mean_1, mean_2, mean_3, mean_4,
                    lcl_1, lcl_2, lcl_3, lcl_4, 
                    ucl_1, ucl_2, ucl_3, ucl_4),
                names_to="unit_length") %>% 
    separate(unit_length, into=c("unit", "truncation"), sep = "_") %>% 
    pivot_wider(names_from=unit,
                values_from=value) %>% 
                mutate(truncation = case_when(truncation == 1 ~ "FX*",
                truncation == 2 ~ "FXX*",
                truncation == 3 ~ "FXX.X*",
                truncation == 4 ~ "FXX.XX*"))
```

## Plotting
```{r fig.height=5, fig.width=10}
log_time()
source("../src/individual_unique_diagnoses_functions.r")

truncation_plot <- save_truncation_plot(df_truncation, "examine_truncation_individual_unique_diagnoses_by_quarter")

truncation_plot
```

```{r fig.height=5, fig.width=10}
log_time()
source("../src/individual_unique_diagnoses_functions.r")

df_mitigation <- df_outpatient_for_individual %>% 
        filter(period > ymd("2012-12-31")) %>% 
        mutate(origin = "outpatient_all") %>% 
        bind_rows(mutate(df_outpatient_most_severe, origin = "most_severe")) %>% 
        bind_rows(mutate(df_outpatient_last_visit_only, origin = "final_visit")) %>% 
        mutate(period = as.Date(period)) %>% 
        filter(period > ymd("2019-01-01") | origin == "outpatient_all") %>% 
        mutate(origin = case_when(origin == "outpatient_all" ~ "Unmitigated",
                                origin == "final_visit" ~ "Final visit",
                                origin == "most_severe" ~ "Most severe"))

mitigation_plot <- save_mitigation_strategy_plot(df_mitigation)

mitigation_plot
```

```{r}
source("../src/individual_unique_diagnoses_functions.r")
log_time()

save_combined_plots(hierarchy_plot, mitigation_plot, "combined_individual_unique_diagnoses")
```


# make p value plots for both df_mitigation and df_truncation
move labels a bit to the right and add p value starts before the label


# Testing
Mitigation
```{r}
df_mitigation <- df_outpatient_for_individual %>% 
                            filter(period > ymd("2012-12-31")) %>% 
                            mutate(origin = "outpatient_all") %>% 
                            bind_rows(mutate(df_outpatient_most_severe, origin = "most_severe")) %>% 
                            bind_rows(mutate(df_outpatient_last_visit_only, origin = "final_visit")) %>% 
                            mutate(period = as.Date(period))


pacman::p_load(fable, tsibble, feasts, urca)

# Binary indicator for date in LPR2/LPR3
df_mitigation <- df_mitigation %>% 
  mutate(lpr3 = if_else(period < "2019-02-03", 0, 1)) 
  

# What to report? 
# pdq(0,0,0) = linear model / t.test (no detrending)
# pdq(0,1,0) = liear model with differencing
# pdq(1,1,0) = autoregressive model with differencing
df_mitigation %>% 
  mutate(period = yearquarter(period)) %>%
  select(starts_with("mean"), period, origin, lpr3) %>% 
  pivot_longer(cols=starts_with("mean"), names_to = "mean_n") %>% 
  as_tsibble(key = c(origin, mean_n), index = period) %>% 
  model(arima = ARIMA(value ~ 1 + lpr3 + pdq(0,0,0) + PDQ(0,0,0))) %>% 
  coef() %>% 
  select(!.model)
```

Truncation
Changepoints plotted on original time series
```{r}

source("../src/change_point_detection.R")

changepoint_plots <- list()
for(truncation_level in unique(df_truncation$truncation)){
  sub <- df_truncation %>% 
    filter(truncation == truncation_level) %>% 
    arrange(period)
  p <- estimate_and_plot_changepoints(
    sub$mean,
    sub$period,
    do_smoothing = FALSE,
    detrend_method = "difference") +
    labs(title = truncation_level)
  
  changepoint_plots[[truncation_level]] <- p
}
wrap_plots(changepoint_plots)

```


Plot original and detrended time series
```{r}
detrended_ts <- list()
for(truncation_level in unique(df_truncation$truncation)){
  sub <- df_truncation %>% 
    filter(truncation == truncation_level) %>% 
    arrange(period)
  p <- plot_detrended_ts(sub$mean,
                                 sub$period,
                               detrending_method = "difference",
                         do_smoothing = FALSE) +
    labs(title = truncation_level)
  
  detrended_ts[[truncation_level]] <- p
}

wrap_plots(detrended_ts)

```


Hypothesis test: was there a change diagnoses during the transition?
```{r}

# binary indicator for date in LPR2/LPR3
df_truncation <- df_truncation %>% 
  mutate(lpr3 = if_else(period < "2019-02-03", 0, 1)) 
  

# What to report? 
# pdq(0,0,0) = linear model / t.test (no detrending)
# pdq(0,1,0) = liear model with differencing
# pdq(1,1,0) = autoregressive model with differencing
df_truncation %>% 
  mutate(period = yearquarter(period)) %>% 
  as_tsibble(key = truncation, index = period) %>% 
  model(arima = ARIMA(mean ~ 1 + lpr3 + pdq(1,1,0) + PDQ(0,0,0))) %>% 
  coef() %>% 
  select(!.model)


```